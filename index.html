<!doctype html>
<html lang="en" data-theme="dark" data-style="corporate">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />

  <title>Wheat Campaign Dashboard</title>
  <meta name="description" content="Buctril Super – Wheat Activations 2025 dashboard: reach, conversion, sessions, media, and map insights for farmer education." />

  <link rel="icon" type="image/png" href="assets/Interact.png" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

  <!-- Main CSS -->
  <link rel="stylesheet" href="style.css?v=20260107-16" />

  <!-- Leaflet CSS (local-first; CDN fallbacks if blocked) -->
  <link id="leafletCss" rel="stylesheet" href="assets/leaflets/dist/leaflet.css" />
  <script>
    (function () {
      const link = document.getElementById('leafletCss');
      if (!link) return;
      const fallbacks = [
        'assets/leaflets/dist/leaflet.css',
        'https://unpkg.com/leaflet@1.9.4/dist/leaflet.css',
        'https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.css',
        'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css'
      ];
      let i = 0;
      link.addEventListener('error', () => {
        i += 1;
        if (i < fallbacks.length) link.href = fallbacks[i];
      });
    })();
  </script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,700;1,700&display=swap" rel="stylesheet">
  <script>
    window.__REDUCE_MOTION__ = !!(window.matchMedia && window.matchMedia('(prefers-reduced-motion: reduce)').matches);
  </script>
  <!-- Added CDNs for new features -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
</head>

<body>
  <!-- Inline SVG icon sprite (no external icon dependencies) -->
  <svg id="svgSprite" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" style="position:absolute;width:0;height:0;overflow:hidden">
    <symbol id="i-calendar" viewBox="0 0 24 24">
      <path d="M7 2v2M17 2v2M4 7h16M6 10h4M6 14h4M14 10h4M14 14h4" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
      <rect x="4" y="5" width="16" height="17" rx="2" fill="none" stroke="currentColor" stroke-width="2"/>
    </symbol>
    <symbol id="i-users" viewBox="0 0 24 24">
      <path d="M16 11a4 4 0 1 0-8 0 4 4 0 0 0 8 0Z" fill="none" stroke="currentColor" stroke-width="2"/>
      <path d="M4 21a8 8 0 0 1 16 0" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
    </symbol>
    <symbol id="i-leaf" viewBox="0 0 24 24">
      <path d="M20 4c-8 0-14 6-14 14 8 0 14-6 14-14Z" fill="none" stroke="currentColor" stroke-width="2" stroke-linejoin="round"/>
      <path d="M6 18c4-4 7-6 12-8" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
    </symbol>
    <symbol id="i-target" viewBox="0 0 24 24">
      <circle cx="12" cy="12" r="9" fill="none" stroke="currentColor" stroke-width="2"/>
      <circle cx="12" cy="12" r="5" fill="none" stroke="currentColor" stroke-width="2"/>
      <circle cx="12" cy="12" r="1.5" fill="currentColor"/>
    </symbol>
    <symbol id="i-bulb" viewBox="0 0 24 24">
      <path d="M9 18h6M10 22h4" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
      <path d="M12 2a7 7 0 0 0-4 12c1 1 1 2 1 3h6c0-1 0-2 1-3A7 7 0 0 0 12 2Z" fill="none" stroke="currentColor" stroke-width="2" stroke-linejoin="round"/>
    </symbol>
    <symbol id="i-shield" viewBox="0 0 24 24">
      <path d="M12 2 20 6v6c0 5-3.5 9.5-8 10-4.5-.5-8-5-8-10V6l8-4Z" fill="none" stroke="currentColor" stroke-width="2" stroke-linejoin="round"/>
      <path d="m9 12 2 2 4-5" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
    </symbol>
    <symbol id="i-clock" viewBox="0 0 24 24">
      <circle cx="12" cy="12" r="9" fill="none" stroke="currentColor" stroke-width="2"/>
      <path d="M12 7v6l4 2" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
    </symbol>
    <symbol id="i-star" viewBox="0 0 24 24">
      <path d="m12 3 2.6 5.6 6.1 .9-4.4 4.3 1 6.1-5.3-2.9-5.3 2.9 1-6.1L3.3 9.5l6.1-.9L12 3Z" fill="none" stroke="currentColor" stroke-width="2" stroke-linejoin="round"/>
    </symbol>
    <symbol id="i-chevron-left" viewBox="0 0 24 24">
      <path d="M15 18l-6-6 6-6" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
    </symbol>
    <symbol id="i-chevron-right" viewBox="0 0 24 24">
      <path d="M9 18l6-6-6-6" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
    </symbol>
    <symbol id="i-chevron-down" viewBox="0 0 24 24">
      <path d="M6 9l6 6 6-6" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
    </symbol>
    <symbol id="i-sun" viewBox="0 0 24 24">
      <circle cx="12" cy="12" r="4" fill="none" stroke="currentColor" stroke-width="2"/>
      <path d="M12 2v2M12 20v2M4.93 4.93l1.41 1.41M17.66 17.66l1.41 1.41M2 12h2M20 12h2M4.93 19.07l1.41-1.41M17.66 6.34l1.41-1.41" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
    </symbol>
    <symbol id="i-moon" viewBox="0 0 24 24">
      <path d="M21 12.8A8.5 8.5 0 0 1 11.2 3 7 7 0 1 0 21 12.8Z" fill="none" stroke="currentColor" stroke-width="2" stroke-linejoin="round"/>
    </symbol>
    <symbol id="i-x" viewBox="0 0 24 24">
      <path d="M6 6l12 12M18 6L6 18" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
    </symbol>
  </svg>

  <!-- Background video -->
  <div class="bg">
    <video id="bgVideo" class="bgVideo" autoplay loop muted playsinline preload="auto" src="assets/bg.mp4">
    </video>
    <div class="bgShade"></div>
  </div>

  <script>
  // Background video: fall back across multiple filenames (GitHub Pages is case-sensitive).
  (function () {
    const v = document.getElementById('bgVideo');
    if (!v) return;

    const candidates = ['assets/bg.mp4', 'assets/hero-1.mp4', 'assets/interact.mp4'];
    let i = 0;

    function setSrc(idx) {
      v.src = candidates[idx];
      v.load();
      v.play().catch(() => { /* ignore autoplay block */ });
    }

    v.addEventListener('error', () => {
      i += 1;
      if (i < candidates.length) setSrc(i);
    });

    // Ensure play is attempted even if the browser delays autoplay.
    v.addEventListener('canplay', () => {
      v.play().catch(() => { /* ignore */ });
    });

    setSrc(0);
  })();
  </script>

  <header class="topbar">
    <div class="headerRow">
      <div class="brand">
        <a href="index.html" class="brandLogoLink" aria-label="Home">
          <img src="https://www.vhv.rs/dpng/d/589-5891725_monsanto-bayer-crop-science-logo-png-transparent-png.png"
               alt="Bayer Crop Science logo" class="brandLogo" style="height:40px;" />
          <img src="https://ezbuyag.icnd-cdn.com/images/products/lg_buctril-mc.png"
               alt="Buctril Super logo" class="brandLogo" style="height:40px; margin-left:10px;" />
        </a>
        <div>
          <div class="brandTitle">Wheat Campaign – Farmer Education Dashboard</div>
          <div class="brandSub">Buctril Super – Wheat Activations 2025</div>
        </div>
        <button class="iconBtn" id="themeToggle" aria-label="Toggle theme"><svg class="icon" aria-hidden="true"><use href="#i-sun" xlink:href="#i-sun"></use></svg><span class="srOnly">Toggle theme</span></button>
      </div>

      <nav class="tabBar" role="tablist" aria-label="Dashboard tabs">
      <a class="tabBtn tabBtn--active" data-tab="summary" role="tab" href="#summary">Summary</a>
      <a class="tabBtn" data-tab="media" role="tab" href="#media">Media</a>
      <a class="tabBtn" data-tab="map" role="tab" href="#map">Map</a>
      <a class="tabBtn" data-tab="sessions" role="tab" href="#sessions">Sessions</a>
      <a class="tabBtn" data-tab="feedback" role="tab" href="#feedback">Feedback</a>
      <a class="tabBtn" data-tab="reports" role="tab" href="#reports">Reports</a> <!-- Added Reports tab -->
    </nav>
    </div>

    <!-- Hero slider -->
    <div class="heroWrap" id="heroWrap">
      <div class="heroPlayer" id="heroPlayer">
        <video id="heroVideo" autoplay muted loop playsinline preload="metadata"></video>
        <div class="heroOverlay"></div>

        <div class="heroCaption">
          <div id="heroTitle" class="heroTitle"></div>
          <div id="heroSub" class="heroSub"></div>
        </div>

        <div class="heroControls">
          <button class="iconBtn" id="heroPrev" aria-label="Previous"><svg class="icon" aria-hidden="true"><use href="#i-chevron-left" xlink:href="#i-chevron-left"></use></svg><span class="srOnly">Previous</span></button>
          <button class="iconBtn" id="heroNext" aria-label="Next"><svg class="icon" aria-hidden="true"><use href="#i-chevron-right" xlink:href="#i-chevron-right"></use></svg><span class="srOnly">Next</span></button>
        </div>

        <div class="heroThumbs" id="heroThumbs" aria-label="Hero thumbnails"></div>
      </div>
    </div>

    <!-- Filters -->
    <div class="filtersHeader" id="filtersHeader">
      <div class="filtersMeta" id="filtersMeta">Filters</div>
      <button class="btn btnGhost btnSmall" id="filtersToggle" type="button"
              aria-expanded="true" aria-controls="filtersPanel"><span>Filters</span> <svg class="icon" aria-hidden="true"><use href="#i-chevron-down" xlink:href="#i-chevron-down"></use></svg></button>
    </div>

    <div class="controls" id="filtersPanel">
      <div class="control control--campaign">
        <label for="campaignSelect">Campaign</label>
        <select id="campaignSelect"></select>
      </div>

      <div class="control control--dates">
        <label>Date range</label>
        <div class="rangeRow">
          <input id="dateFrom" type="date" />
          <span class="muted">to</span>
          <input id="dateTo" type="date" />
          <button class="btn" id="applyBtn">Apply</button>
          <button class="btn btnGhost" id="resetBtn">Reset</button>
          <button class="btn btnGhost" id="exportBtn">Export CSV</button>
        </div>
        <div id="rangeHint" class="smallMuted"></div>
      </div>

      <div class="control control--search">
        <label for="nameFilter">Farmer name</label>
        <input id="nameFilter" type="text" placeholder="Search by host name" />
      </div>

      <div class="control control--search">
        <label for="cityFilter">Territory</label>
        <input id="cityFilter" type="text" placeholder="Search by territory" />
      </div>

      <div class="control control--search">
        <label for="regionMulti">Region (REG)</label>
        <select id="regionMulti" multiple>
          <option value="SKR">SKR</option>
          <option value="RYK">RYK</option>
          <option value="DGK">DGK</option>
          <option value="FSD">FSD</option>
          <option value="GUJ">GUJ</option>
        </select>
      </div>

      <div class="control control--search">
        <label for="districtFilter">District</label>
        <input id="districtFilter" type="text" placeholder="Search by district" />
      </div>

      <div class="control control--score">
        <label>Score range</label>
        <div class="scoreRangeRow">
          <input id="scoreMin" type="number" placeholder="Min score" min="0" max="100" step="0.1" />
          <span class="muted">to</span>
          <input id="scoreMax" type="number" placeholder="Max score" min="0" max="100" step="0.1" />
        </div>
      </div>

      <div class="control control--search">
        <label for="semanticSearch">Smart Search</label>
        <input id="semanticSearch" type="text" placeholder="e.g., high score in SKR" />
      </div>
    </div>
  </header>

  <main id="app" class="">
    <section class="tabPanel grid2" data-tab="summary" id="summary">
      <section class="card">
        <h2>Executive summary</h2>
        <div class="muted">Reach, conversion, and impact indicators computed from session rows only. Use the date filter to segment performance.</div>

        <div class="kpis">
          <div class="kpi kpi--sessions"><div class="kpiLabel"><span data-tooltip="Total number of INTERACT field sessions executed."><svg class="ico" aria-hidden="true"><use href="#i-calendar" xlink:href="#i-calendar"></use></svg>Sessions</span></div><div class="kpiVal" id="kpiSessions">—</div></div>
          <div class="kpi kpi--farmers"><div class="kpiLabel"><span data-tooltip="Total farmers reached (refined where attendance index is available)."><svg class="ico" aria-hidden="true"><use href="#i-users" xlink:href="#i-users"></use></svg>Farmers reached</span></div><div class="kpiVal" id="kpiFarmers">—</div></div>
          <div class="kpi kpi--acres"><div class="kpiLabel"><span data-tooltip="Sum of reported wheat acres engaged during sessions."><svg class="ico" aria-hidden="true"><use href="#i-leaf" xlink:href="#i-leaf"></use></svg>Acres engaged</span></div><div class="kpiVal" id="kpiAcres">—</div></div>
          <div class="kpi kpi--estacres"><div class="kpiLabel"><span data-tooltip="Estimated Buctril acres influenced (refined where available)."><svg class="ico" aria-hidden="true"><use href="#i-target" xlink:href="#i-target"></use></svg>Estimated Buctril acres</span></div><div class="kpiVal" id="kpiEstAcres">—</div></div>
          <div class="kpi kpi--awareness"><div class="kpiLabel"><span data-tooltip="Average awareness after INTERACT education (higher is better)."><svg class="ico" aria-hidden="true"><use href="#i-bulb" xlink:href="#i-bulb"></use></svg>Awareness (avg)</span></div><div class="kpiVal" id="kpiAwareness">—</div></div>
          <div class="kpi kpi--definite"><div class="kpiLabel"><span data-tooltip="Average definite intent to use after education."><svg class="ico" aria-hidden="true"><use href="#i-shield" xlink:href="#i-shield"></use></svg>Definite intent (avg)</span></div><div class="kpiVal" id="kpiDefinite">—</div></div>
          <div class="kpi kpi--used"><div class="kpiLabel"><span data-tooltip="Average % who used last year (baseline familiarity)."><svg class="ico" aria-hidden="true"><use href="#i-clock" xlink:href="#i-c...(truncated 7006 characters)...st">Oldest first</option>
          </select>
        </div>
      </div>

      <div id="mediaGrid" class="mediaGrid"></div>
      <div class="mediaFooter">
        <button class="btn btnGhost" id="mediaLoadMore" type="button">Load more</button>
        <div class="smallMuted" id="mediaCount"></div>
      </div>
    </section>

    <section class="tabPanel card" data-tab="feedback" id="feedback">
      <h2>Feedback</h2>
      <div class="muted">We value your feedback. Send us a message via WhatsApp or email by providing the appropriate contact information below.</div>
      <div class="divider"></div>

      <div class="grid2">
        <div class="card">
          <div class="control">
            <label for="fbPhone">Phone (WhatsApp)</label>
            <input type="tel" id="fbPhone" placeholder="Enter phone number" />
          </div>
          <div class="control">
            <label for="fbEmail">Email</label>
            <input type="email" id="fbEmail" placeholder="Enter email address" />
          </div>
          <div class="control">
            <label for="fbMessage">Message</label>
            <textarea id="fbMessage" rows="6" placeholder="Type your feedback here…"></textarea>
          </div>
          <div class="drawerActions">
            <button class="btn" id="fbSendWhatsApp">Send via WhatsApp</button>
            <button class="btn btnGhost" id="fbSendEmail">Send via Email</button>
          </div>
          <div id="fbFeedbackMsg" class="smallMuted"></div>
        </div>

        <div class="card">
          <h3>Quick links</h3>
          <ul class="muted">
            <li><a href="healthcheck.html" class="link">Healthcheck</a></li>
            <li><a href="sheets.html" class="link">Sheets browser</a></li>
            <li><a href="report.html" class="link">Campaign analysis report</a></li>
          </ul>
        </div>
      </div>
    </section>

    <!-- Added Reports tab -->
    <section class="tabPanel card" data-tab="reports" id="reports">
      <h2>Modern Reports</h2>
      <button id="generatePdfBtn">Generate PDF Report</button>
      <div id="reportPreview" class="report-preview"></div>
      <canvas id="trendChart" class="chartWrap"></canvas> <!-- Added trend chart -->
    </section>
  </main>

  <footer class="footer" aria-label="Footer">
    <div class="footerBrands">
      <div class="brandPill">
        <img src="assets/interact.gif" alt="INTERACT"/>
        <span>INTERACT Solutions</span>
      </div>
      <div class="brandPill">
        <img src="assets/bayer.svg" alt="Bayer"/>
        <span>Bayer Crop Science</span>
      </div>
    </div>
    <div class="smallMuted">This dashboard is designed to be static-host friendly and offline-friendly. Use the Healthcheck to validate data and asset availability.</div>
  </footer>

  <div class="drawerOverlay hidden" id="drawerOverlay" aria-hidden="true"></div>
  <aside class="drawer hidden" id="sessionDrawer" aria-hidden="true" aria-label="Session details">
    <div class="drawerTop">
      <div>
        <div class="drawerTitle" id="drawerTitle">Session</div>
        <div class="drawerSub" id="drawerSub">—</div>
      </div>
      <button class="iconBtn" id="drawerClose" aria-label="Close"><svg class="icon" aria-hidden="true"><use href="#i-x" xlink:href="#i-x"></use></svg><span class="srOnly">Close</span></button>
    </div>

    <div class="drawerBody">
      <div class="kpis kpis--compact">
        <div class="kpi"><div class="kpiLabel">Farmers</div><div class="kpiVal" id="dFarmers">—</div></div>
        <div class="kpi"><div class="kpiLabel">Acres</div><div class="kpiVal" id="dAcres">—</div></div>
        <div class="kpi"><div class="kpiLabel">Score</div><div class="kpiVal" id="dScore">—</div></div>
      </div>

      <div class="divider"></div>
      <div id="dMeta" class="muted"></div>

      <div class="divider"></div>
      <h3>Outcomes</h3>
      <div id="dOutcomes" class="muted">—</div>

      <div class="divider"></div>
      <h3>Recommended next actions</h3>
      <ul id="dActions" class="bullets"><li class="muted">—</li></ul>

      <div class="divider"></div>
      <div class="drawerActions">
        <a class="btn" id="dOpenSheet" href="#">Open sheet</a>
        <a class="btn btnGhost" id="dOpenDetails" href="#">Open details</a>
        <a class="btn btnGhost" id="dOpenMaps" href="#" target="_blank" rel="noopener">Open in Google Maps</a>
      </div>

      <div class="divider"></div>
      <h3>Sheet summary</h3>
      <div id="dSheetSummary" class="muted">Loading…</div>

      <div class="divider"></div>
      <h3>Media</h3>
      <div id="dMedia" class="mediaRow"></div>
    </div>
  </aside>

  <div id="lightbox" class="lightbox" role="dialog" aria-modal="true" aria-label="Media viewer">
    <div class="lightboxInner">
      <div class="lightboxTop">
        <div id="lbTitle" class="muted">Media</div>
        <button class="iconBtn" id="lbClose" aria-label="Close"><svg class="icon" aria-hidden="true"><use href="#i-x" xlink:href="#i-x"></use></svg><span class="srOnly">Close</span></button>
      </div>
      <div class="lightboxBody" id="lbBody"></div>
      <div class="share-options"> <!-- Added share options -->
        <button id="shareTwitter">Share on X</button>
        <button id="shareLinkedIn">Share on LinkedIn</button>
        <button id="generateQr">Generate QR</button>
        <div id="qrContainer"></div>
      </div>
    </div>
  </div>

  <!-- Scripts (defer for performance). Keep order: Chart.js then dashboard.js -->
  <script defer src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
  <script defer src="dashboard.js?v=20260107-16"></script>


  <!-- Hero slider (auto-advance) -->
  <script>
  (function() {
    const prefersReduced = window.matchMedia && window.matchMedia('(prefers-reduced-motion: reduce)').matches;

    const videos = [
      { file: 'assets/atlantis.mp4', title: 'Field Activation', caption: 'Wheat weed-control activations across districts.' },
      { file: 'assets/bayer.mp4', title: 'Trust & Safety', caption: 'Bayer Crop Science—trusted crop protection.' },
      { file: 'assets/buctril.mp4', title: 'Buctril Super Protection', caption: 'Safeguarding wheat fields under protection.' },
      { file: 'assets/interact.mp4', title: 'INTERACT in Action', caption: 'Educating farmers on effective weed-control strategies.' }
    ];

    let current = 0;
    let timer = null;
    let heroStats = null;

    const heroVideo = document.getElementById('heroVideo');
    const heroTitle = document.getElementById('heroTitle');
    const heroSub   = document.getElementById('heroSub');
    const thumbs    = document.getElementById('heroThumbs');
    const prevBtn   = document.getElementById('heroPrev');
    const nextBtn   = document.getElementById('heroNext');

    if (!heroVideo || !thumbs) return;

    function stop() {
      if (timer) { clearInterval(timer); timer = null; }
    }

    function start() {
      if (prefersReduced) return;
      stop();
      timer = setInterval(() => setHero(current + 1), 6500);
    }

    function setHero(i) {
      current = (i + videos.length) % videos.length;
      const v = videos[current];

      heroVideo.muted = true;
      heroVideo.playsInline = true;
      heroVideo.src = v.file;
      heroVideo.load();

      // Attempt autoplay; if blocked, still rotate
      heroVideo.play().catch(() => { /* ignore */ });

      if (heroTitle) heroTitle.textContent = v.title;
      if (heroSub) heroSub.textContent = (function(){
        const base = v.caption || '';
        if (!heroStats) return base;
        const parts = [];
        if (heroStats.farmers) parts.push(`${heroStats.farmers.toLocaleString()} farmers reached`);
        if (Number.isFinite(heroStats.awareness)) parts.push(`Awareness ${heroStats.awareness}%`);
        if (Number.isFinite(heroStats.definite)) parts.push(`Definite ${heroStats.definite}%`);
        if (Number.isFinite(heroStats.score)) parts.push(`Score ${heroStats.score}`);
        return parts.length ? `${base} • ${parts.slice(0,3).join(' · ')}` : base;
      })();

      Array.from(thumbs.children).forEach((el, idx) => {
        el.classList.toggle('active', idx === current);
      });
    }

    // Build thumbs
    videos.forEach((v, idx) => {
      const d = document.createElement('div');
      d.className = 'heroThumb';
      d.innerHTML = `<video autoplay loop muted playsinline preload="metadata" src="${v.file}"></video><div class="badge">${idx+1}</div>`;
      d.addEventListener('click', () => { setHero(idx); start(); });
      thumbs.appendChild(d);
    });

    prevBtn?.addEventListener('click', () => { setHero(current - 1); start(); });
    nextBtn?.addEventListener('click', () => { setHero(current + 1); start(); });

    // Pause on hover/focus
    const heroPlayer = document.getElementById('heroPlayer');
    heroPlayer?.addEventListener('mouseenter', stop);
    heroPlayer?.addEventListener('mouseleave', start);
    heroPlayer?.addEventListener('focusin', stop);
    heroPlayer?.addEventListener('focusout', start);

    // Pause if tab hidden
    document.addEventListener('visibilitychange', () => {
      if (document.hidden) stop();
      else start();
    });

    setHero(0);
    // Allow dashboard.js to push computed KPI stats into hero captions.
    window.WHEAT_HERO = window.WHEAT_HERO || {};
    window.WHEAT_HERO.updateStats = function(stats){
      heroStats = stats || null;
      apply();
    };

    start();
  })();
  </script>


  <script>
  // v16: background video autoplay handling + fallback
  (function() {
    const v = document.getElementById('bgVideo');
    if (!v) return;

    let attempted = false;

    function attemptAutoplay() {
      if (attempted) return;
      attempted = true;

      try {
        v.muted = true;
        v.setAttribute('muted', '');
        v.playsInline = true;
        v.setAttribute('playsinline', '');
      } catch (e) {}

      const playPromise = v.play();
      if (playPromise && typeof playPromise.catch === 'function') {
        playPromise.catch(() => {
          const fallback = document.createElement('div');
          fallback.className = 'bgFallback';
          if (v.parentElement) v.parentElement.appendChild(fallback);
          v.classList.add('fallback');
        });
      }
    }

    attemptAutoplay();
    document.addEventListener('click', attemptAutoplay, { once: true });
    document.addEventListener('touchstart', attemptAutoplay, { once: true });
  })();
  </script>

  <!-- Theme toggle -->
  <script>
  (function() {
    const htmlEl = document.documentElement;
    const toggleBtn = document.getElementById('themeToggle');

    function applyTheme(t) {
      htmlEl.setAttribute('data-theme', t);
      localStorage.setItem('theme', t);
      try {
        window.__THEME__ = t;
        document.dispatchEvent(new CustomEvent('themechange', { detail: { theme: t } }));
      } catch (_e) {}
      if (toggleBtn) {
        const sym = (t === 'light') ? 'i-moon' : 'i-sun';
        toggleBtn.innerHTML = `<svg class="icon" aria-hidden="true"><use href="#${sym}" xlink:href="#${sym}"></use></svg><span class="srOnly">Toggle theme</span>`;
      }
    }

    const saved = localStorage.getItem('theme');
    if (saved === 'light' || saved === 'dark') {
      applyTheme(saved);
    } else {
      const hr = new Date().getHours();
      applyTheme((hr >= 6 && hr < 18) ? 'light' : 'dark');
    }

    // Campaign context: auto-theme per tab (Summary/Sessions = light; Media/Map/Feedback = dark),
// but do not override a user-selected theme stored in localStorage.
document.addEventListener('tabchange', (e) => {
  const locked = (localStorage.getItem('theme') === 'light' || localStorage.getItem('theme') === 'dark');
  if (locked) return;
  const tab = e?.detail?.tab || '';
  const t = (tab === 'summary' || tab === 'sessions') ? 'light' : 'dark';
  applyTheme(t);
});

toggleBtn?.addEventListener('click', () => {
      const current = htmlEl.getAttribute('data-theme');
      applyTheme(current === 'light' ? 'dark' : 'light');
    });
  })();
  </script>

  <!-- Filters collapse -->
  <script>
  (function () {
    const body = document.body;
    const btn = document.getElementById('filtersToggle');
    const panel = document.getElementById('filtersPanel');
    const meta = document.getElementById('filtersMeta');

    if (!btn || !panel) return;

    const KEY = 'filtersCollapsed';

    function fmtDate(iso) {
      // iso expected: YYYY-MM-DD
      if (!iso || typeof iso !== 'string') return '';
      const m = iso.match(/^(\d{4})-(\d{2})-(\d{2})$/);
      if (!m) return iso;
      return `${m[3]}/${m[2]}/${m[1]}`;
    }

    function updateMeta() {
      if (!meta) return;
      const camp = document.getElementById('campaignSelect');
      const from = document.getElementById('dateFrom');
      const to = document.getElementById('dateTo');

      const campText = camp && camp.selectedOptions && camp.selectedOptions[0]
        ? camp.selectedOptions[0].textContent.trim()
        : 'Campaign';

      const fromText = from?.value ? fmtDate(from.value) : '';
      const toText = to?.value ? fmtDate(to.value) : '';

      const range = (fromText && toText) ? `${fromText} → ${toText}` : '';
      meta.textContent = range ? `${campText} • ${range}` : campText;
    }

    function setCollapsed(collapsed, persist) {
      body.classList.toggle('filters-collapsed', !!collapsed);
      btn.setAttribute('aria-expanded', (!collapsed).toString());
      {
        const sym = collapsed ? 'i-chevron-right' : 'i-chevron-down';
        btn.innerHTML = `<span>Filters</span> <svg class="icon" aria-hidden="true"><use href="#${sym}" xlink:href="#${sym}"></use></svg>`;
      }
      if (persist) localStorage.setItem(KEY, collapsed ? '1' : '0');
      updateMeta();
    }

    // Initialize state (localStorage wins; else auto-collapse on short viewports)
    const saved = localStorage.getItem(KEY);
    if (saved === '1' || saved === '0') {
      setCollapsed(saved === '1', false);
    } else {
      const auto = (window.innerHeight < 760) || (window.innerWidth < 980);
      setCollapsed(auto, false);
    }

    btn.addEventListener('click', () => {
      const isCollapsed = body.classList.contains('filters-collapsed');
      setCollapsed(!isCollapsed, true);
    });

    // Keep the summary in sync as dashboard.js populates inputs
    const bind = (id, ev) => {
      const el = document.getElementById(id);
      if (el) el.addEventListener(ev, () => setTimeout(updateMeta, 0));
    };

    bind('campaignSelect', 'change');
    bind('dateFrom', 'change');
    bind('dateTo', 'change');
    bind('applyBtn', 'click');
    bind('resetBtn', 'click');

    // First paint after dashboard initializes
    window.addEventListener('load', () => setTimeout(updateMeta, 50));
  })();
  </script>

</body>
</html>
