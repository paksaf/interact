<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Session details</title>
  <!-- Set the Interact logo as favicon for consistent branding -->
  <!-- Use the Interact logo as the site favicon -->
  <link rel="icon" type="image/png" href="assets/Interact.png" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="style.css?v=20260101" />
</head>
<body>
  <header class="topbar">
    <div class="brand">
      <!-- Clickable Interact logo linking back to the main dashboard -->
      <a href="index.html" class="brandLogoLink" aria-label="Home">
        <img src="assets/Interact.png" alt="Interact logo" class="brandLogo" onerror="this.style.display='none'" />
      </a>
      <div>
        <div class="brandTitle">Session details</div>
        <div class="brandSub"><a id="backLink" class="link" href="index.html">Home</a></div>
      </div>
      <!-- Theme toggle button for details page -->
      <button class="iconBtn" id="themeToggle" aria-label="Toggle theme">â˜€</button>
    </div>
    <div class="controls">
      <div class="control">
        <label>Session</label>
        <div id="hdr" class="muted">â€”</div>
      </div>
      <div class="control">
        <label>Phones</label>
        <button id="togglePhones" class="btnSmall" type="button">Show phones</button>
      </div>
    </div>
  </header>

  <main class="grid2">
    <section class="card">
      <h2>Overview</h2>
      <div id="overview" class="muted">Loadingâ€¦</div>

      <div class="kpis kpis--compact">
        <div class="kpi"><div class="kpiLabel">Awareness</div><div class="kpiVal" id="kAwareness">â€”</div></div>
        <div class="kpi"><div class="kpiLabel">Definite</div><div class="kpiVal" id="kDefinite">â€”</div></div>
        <div class="kpi"><div class="kpiLabel">Understanding</div><div class="kpiVal" id="kUnderstanding">â€”</div></div>
      </div>

      <div class="divider"></div>
      <h3>Recommended next actions</h3>
      <ul id="actions" class="bullets"><li class="muted">Loadingâ€¦</li></ul>

      <div class="divider"></div>
      <div class="drawerActions">
        <a class="btn" id="openSheet" href="#">Open sheet</a>
        <a class="btn btnGhost" id="openMaps" href="#" target="_blank" rel="noopener">Open in Google Maps</a>
      </div>

      <div class="divider"></div>
      <h3>Sheet summary</h3>
      <div id="sheetSummary" class="muted">Loadingâ€¦</div>
    </section>

    <section class="card">
      <h2>Media</h2>
      <div id="media" class="mediaGrid"></div>
    </section>
  </main>

<script>
(() => {
  'use strict';
  const $$ = (s,r=document)=>r.querySelector(s);
  const esc = (s)=>{const d=document.createElement('div'); d.textContent=String(s??''); return d.innerHTML;};
  const fmtInt = (n) => {
    const x = Number(n);
    return Number.isFinite(x) ? x.toLocaleString() : 'â€”';
  };
  const fmt1 = (n) => {
    const x = Number(n);
    if (!Number.isFinite(x)) return 'â€”';
    const y = Math.round(x * 10) / 10;
    return (y % 1 === 0) ? String(y.toFixed(0)) : String(y.toFixed(1));
  };
  const fmtPct = (n) => {
    const x = Number(n);
    return Number.isFinite(x) ? (fmt1(x) + '%') : 'â€”';
  };

  // Mask a phone number for privacy, retaining only the last 4 digits. If the
  // provided value has fewer than 4 digits, return it unchanged. Dashes are
  // inserted for readability (***-***-1234). Non-string inputs are returned
  // as-is.
  // Phone masking toggle. When showFullPhones is true, phone numbers will be
  // rendered in full; otherwise, only the last four digits are shown.
  let showFullPhones = false;
  try {
    showFullPhones = localStorage.getItem('showFullPhones') === 'true';
  } catch (_e) {}

  function maskPhone(p) {
    const raw = String(p || '').replace(/\s+/g, '');
    if (!raw) return '';
    if (showFullPhones) return raw;
    if (raw.length < 4) return raw;
    const tail = raw.slice(-4);
    return '***-***-' + tail;
  }

  const num = (v) => (typeof v === 'number' && Number.isFinite(v)) ? v : NaN;
  const BASE = new URL('.', location.href);
  const url = (p)=>new URL(p, BASE).toString();
  const qs = new URLSearchParams(location.search);
  const campaign = qs.get('campaign') || 'buctril-super-2025';
  const sessionId = Number(qs.get('session') || 0);

  $$('#backLink').href = `index.html?campaign=${encodeURIComponent(campaign)}#sessions`;

  // Robust fetch helper with retry and timeout. Similar to the version used
  // in dashboard.js and sheets.html. Attempts to fetch the given path
  // multiple times with a timeout. If all attempts fail, throws an error.
  async function fetchJson(p, retries = 3, timeout = 8000) {
    for (let attempt = 1; attempt <= retries; attempt++) {
      const controller = new AbortController();
      const timer = setTimeout(() => controller.abort(), timeout);
      try {
        const r = await fetch(url(p), { cache:'no-store', signal: controller.signal });
        clearTimeout(timer);
        if (!r.ok) throw new Error(`Status ${r.status}`);
        return await r.json();
      } catch (e) {
        clearTimeout(timer);
        if (attempt === retries) {
          console.error(e);
          throw new Error(`Unable to load ${p}: ${e.message}`);
        }
        await new Promise(res => setTimeout(res, 500 * attempt));
      }
    }
    throw new Error(`Failed to load ${p}`);
  }

  // --- Media path resolution (match dashboard behavior) ---
  const existsCache = new Map(); // url -> boolean

  function normalizeMediaPath(p) {
    const raw = String(p ?? '').trim();
    if (!raw) return '';
    if (/^(https?:|data:|blob:)/i.test(raw)) return raw;
    let x = raw.replace(/^\.?\//,'').replace(/^\//,'');
    if (x.startsWith('assets/')) return x;
    if (x.startsWith('gallery/')) return 'assets/' + x;
    if (!x.includes('/')) return 'assets/gallery/' + x;
    return x;
  }

  function candidatePaths(p) {
    const norm = normalizeMediaPath(p);
    if (!norm) return [];
    if (/^(https?:|data:|blob:)/i.test(norm)) return [norm];

    const candidates = [];
    const add = (v) => { if (v && !candidates.includes(v)) candidates.push(v); };

    add(norm);
    if (!norm.startsWith('assets/gallery/') && !norm.includes('/gallery/')) {
      const fname = norm.split('/').pop();
      add('assets/gallery/' + fname);
    }

    const isImg = /\.(?:jpeg|jpg|png|webp)$/i.test(norm);
    const isVid = /\.(?:mp4|webm)$/i.test(norm);
    const imgExts = ['.jpeg','.jpg','.png','.webp'];

    function addVariantBases(base, out) {
      const push = (v) => { if (v && !out.includes(v)) out.push(v); };
      const m1 = base.match(/^(.*?)([a-z])$/i);
      const m2 = base.match(/^(.*?)[_-]([a-z])$/i);
      if (m1) {
        const root = m1[1];
        const suf = m1[2];
        push(base);
        push(root + '_' + suf);
        push(root + '-' + suf);
        push(root);
        return;
      }
      if (m2) {
        const root = m2[1];
        const suf = m2[2];
        push(base);
        push(root + suf);
        push(root);
        return;
      }
      push(base);
      push(base + 'a');
      push(base + '_a');
      push(base + '-a');
    }

    if (isImg) {
      const base = norm.replace(/\.(?:jpeg|jpg|png|webp)$/i, '');
      const bases = [];
      addVariantBases(base, bases);
      for (const b of bases) for (const e of imgExts) add(b + e);
    }

    if (isVid) {
      const base = norm.replace(/\.(?:mp4|webm)$/i, '');
      const bases = [];
      addVariantBases(base, bases);
      for (const b of bases) { add(b + '.mp4'); add(b + '.webm'); }
    }

    return candidates;
  }

  async function assetExists(relOrAbs) {
    const u = /^(https?:|data:|blob:)/i.test(relOrAbs) ? relOrAbs : url(relOrAbs);
    if (existsCache.has(u)) return existsCache.get(u);
    try {
      const r = await fetch(u, { method: 'HEAD', cache: 'no-store' });
      existsCache.set(u, r.ok);
      return r.ok;
    } catch (_e) {
      try {
        const r = await fetch(u, { method: 'GET', headers: { Range: 'bytes=0-0' }, cache: 'no-store' });
        existsCache.set(u, r.ok);
        return r.ok;
      } catch (_e2) {
        existsCache.set(u, false);
        return false;
      }
    }
  }

  async function resolveFirstExisting(p) {
    const cands = candidatePaths(p);
    for (const c of cands) {
      if (await assetExists(c)) return c;
    }
    return '';
  }

  function attachSmartImage(imgEl, path) {
    const ph = 'assets/placeholder.svg';
    let cancelled = false;
    (async () => {
      const chosen = await resolveFirstExisting(path);
      if (cancelled) return;
      imgEl.src = url(chosen || ph);
    })();
    imgEl.onerror = ()=>{imgEl.onerror=null; imgEl.src=url(ph);};
    return () => { cancelled = true; };
  }

  function attachSmartVideo(videoEl, path) {
    const ph = 'assets/placeholder-video.mp4';
    let tried = false;
    videoEl.preload = 'metadata';
    videoEl.controls = true;
    videoEl.addEventListener('click', async () => {
      if (tried) return;
      tried = true;
      const chosen = await resolveFirstExisting(path);
      videoEl.src = url(chosen || ph);
      videoEl.play().catch(()=>{});
    });
    videoEl.onerror = ()=>{videoEl.onerror=null; videoEl.src=url(ph);};
  }

  async function boot() {
    const sj = await fetchJson(`data/${campaign}/sessions.json`);
    const sessions = Array.isArray(sj.sessions) ? sj.sessions : [];
    const s = sessions.find(x => Number(x.id) === sessionId);
    if (!s) throw new Error('Session not found.');

    $$('#hdr').innerHTML = `<b>Session ${esc(s.id)}</b> â€¢ <span class="badge">${esc(s.sheetRef||'')}</span> â€¢ ${esc(s.date||'')}`;
    $$('#overview').innerHTML = `
      <div><b>District:</b> ${esc(s.district||'')}</div>
      <div><b>Village/Spot:</b> ${esc(s.village||s.spot||'')}</div>
      <div><b>Dealer:</b> ${esc(s.dealer?.nearest||s.dealer?.name||'')}</div>
      <div><b>Host:</b> ${esc(s.host?.name||'')} â€¢ ${esc(maskPhone(s.host?.phone)||'')}</div>
      <div><b>Sales:</b> ${esc(s.salesRep?.name||'')} â€¢ ${esc(maskPhone(s.salesRep?.phone)||'')}</div>
      <div><b>Score:</b> ${esc(String(s.score ?? ''))}</div>
      ${s.topReasonUse ? `<div><b>Top reason to use:</b> ${esc(s.topReasonUse)}</div>` : ''}
      ${s.topReasonNotUse ? `<div><b>Top reason not to use:</b> ${esc(s.topReasonNotUse)}</div>` : ''}
      ${s.competitors ? `<div><b>Competitors:</b> ${esc(s.competitors)}</div>` : ''}
    `;

        // Outcome KPIs and recommended actions
    const mtr = s.metrics || {};
    const aw = num(mtr.awarenessPct);
    const de = num(mtr.definitePct);
    const un = num(mtr.avgUnderstanding);

    $$('#kAwareness').textContent = fmtPct(aw);
    $$('#kDefinite').textContent = fmtPct(de);
    $$('#kUnderstanding').textContent = Number.isFinite(un) ? (fmt1(un) + ' / 3') : 'â€”';

    const acts = [];
    const uPct = Number.isFinite(un) ? (un / 3 * 100) : NaN;
    if (Number.isFinite(aw) && aw < 60) acts.push('Increase awareness: add a short pre-activation dealer touchpoint and begin the session with weed-pressure framing + product positioning.');
    if (Number.isFinite(de) && de < 70) acts.push('Improve conversion: strengthen objection-handling talk track; use per-acre ROI and a demo-plot story to close.');
    if (Number.isFinite(uPct) && uPct < 75) acts.push('Improve clarity: simplify key messages, use visuals, and do a quick comprehension check mid-session.');
    const rn = s.reasonsNotUse && typeof s.reasonsNotUse === 'object' ? s.reasonsNotUse : {};
    if (Number(rn['Price Too High'] || 0) > 0) acts.push('Address price objections: explain value in per-acre cost terms and emphasize reliability / yield protection.');
    if (Number(rn['Not Available'] || 0) > 0) acts.push('Fix availability risk: confirm stock at nearest dealer and share a clear purchase path at the end of the session.');
    if (Number(rn['Fear of Burn'] || 0) > 0) acts.push('Reduce burn concerns: emphasize correct dose + timing and show safe-use guidance with examples.');

    const actEl = $$('#actions');
    if (actEl) actEl.innerHTML = acts.length ? acts.map(x => `<li>${esc(x)}</li>`).join('') : '<li class="muted">No critical flags for this session based on thresholds.</li>';

const sheetUrl = `sheets.html?campaign=${encodeURIComponent(campaign)}&sheet=${encodeURIComponent(s.sheetRef)}`;
    $$('#openSheet').href = sheetUrl;

    const lat = Number(s.geo?.lat), lng = Number(s.geo?.lng);
    const maps = (Number.isFinite(lat)&&Number.isFinite(lng)) ? `https://www.google.com/maps?q=${lat},${lng}` : '#';
    $$('#openMaps').href = maps;

    // Sheet summary
    try {
      const sh = await fetchJson(`data/${campaign}/sheets/${s.sheetRef}.json`);
      const m = sh.meta || {};
      const f = sh.feedback || {};
      const farmers = Array.isArray(sh.farmers) ? sh.farmers : [];
      const top = [...farmers].sort((a,b)=>Number(b.acres||0)-Number(a.acres||0)).slice(0,5);
      $$('#sheetSummary').innerHTML = `
        <div class="muted"><b>${esc(m.sheet||s.sheetRef)}</b> â€¢ Date: ${esc(m.date||s.date||'')} â€¢ Farmers present: ${esc(String(m.farmers_present||''))} â€¢ Acres: ${esc(String(m.acres||''))}</div>
        ${f.host_comment ? `<div><b>Host comment:</b> ${esc(f.host_comment)}</div>` : ''}
        ${f.sales_feedback ? `<div><b>Sales feedback:</b> ${esc(f.sales_feedback)}</div>` : ''}
        ${f.manager_note ? `<div><b>Manager note:</b> ${esc(f.manager_note)}</div>` : ''}
        <div class="divider"></div>
        <div><b>Top farmers</b></div>
        ${top.length ? `<ul>${top.map(x=>`<li>${esc(x.name||'')} â€” ${esc(String(x.acres ?? ''))} acres</li>`).join('')}</ul>` : '<div class="muted">No farmer rows found.</div>'}
      `;
    } catch (e) {
      $$('#sheetSummary').innerHTML = `<div class="muted">Could not load sheet.</div><div class="smallMuted">${esc(e.message)}</div>`;
    }

    // Media
    const media = $$('#media');
    const imgs = (s.media && Array.isArray(s.media.images)) ? s.media.images : [];
    const vids = (s.media && Array.isArray(s.media.videos)) ? s.media.videos : [];
    // Combine images and videos into a single array and deduplicate by path. Some session
    // definitions include duplicate file names (e.g. '24.jpeg' and '24a.jpeg' may point
    // to the same content). Deduplicating here prevents rendering the same media twice.
    const rawItems = [
      ...imgs.map(p => ({ type: 'image', path: p })),
      ...vids.map(p => ({ type: 'video', path: p }))
    ];
    const seen = new Set();
    const items = [];
    for (const it of rawItems) {
      const pathKey = String(it.path || '').trim();
      if (!pathKey) continue;
      if (!seen.has(pathKey)) {
        seen.add(pathKey);
        items.push(it);
      }
    }
    if (!items.length) {
      media.innerHTML = '<div class="muted">No media for this session.</div>';
    } else {
      media.innerHTML = items.map((it, i)=> {
        return it.type === 'image'
          ? `<div class="mediaThumb"><img data-i="${i}" alt="image"/></div>`
          : `<div class="mediaThumb"><video data-i="${i}" controls playsinline></video></div>`;
      }).join('');
      items.forEach((it, i) => {
        const el = media.querySelector(`[data-i="${i}"]`);
        if (!el) return;
        if (it.type === 'image') attachSmartImage(el, it.path);
        else attachSmartVideo(el, it.path);
      });
    }
  }

  boot().catch(e=> {
    $$('#overview').innerHTML = `<div class="muted">Failed to load.</div><div class="smallMuted">${esc(e.message)}</div>`;
    $$('#sheetSummary').textContent = 'â€”';
  });

  // Initialise the phone toggle button. Show current state (show/hide) and
  // allow the user to flip the preference. Reloads the session view when
  // toggled to apply the new masking.
  const phoneBtn = document.getElementById('togglePhones');
  if (phoneBtn) {
    const updatePhoneBtn = () => {
      phoneBtn.textContent = showFullPhones ? 'Hide phones' : 'Show phones';
    };
    updatePhoneBtn();
    phoneBtn.addEventListener('click', () => {
      // When phones are hidden, ask for the fixed password to reveal them. When
      // already visible, hide without prompting. Password is "Interact".
      if (!showFullPhones) {
        const pw = window.prompt('Enter password to show full phone numbers:');
        if (pw !== 'Interact') {
          return;
        }
        showFullPhones = true;
      } else {
        showFullPhones = false;
      }
      try { localStorage.setItem('showFullPhones', String(showFullPhones)); } catch (_e) {}
      updatePhoneBtn();
      // Refresh the view to apply updated masking
      window.location.reload();
    });
  }
})();
</script>
<!-- Theme toggle script for details page -->
<script>
(function() {
  const htmlEl = document.documentElement;
  const toggleBtn = document.getElementById('themeToggle');
  function applyTheme(t) {
    htmlEl.setAttribute('data-theme', t);
    localStorage.setItem('theme', t);
    if (toggleBtn) toggleBtn.textContent = (t === 'light') ? 'ðŸŒ™' : 'â˜€';
  }
  const saved = localStorage.getItem('theme');
  if (saved === 'light' || saved === 'dark') {
    applyTheme(saved);
  } else {
    const hr = new Date().getHours();
    const defaultTheme = (hr >= 6 && hr < 18) ? 'light' : 'dark';
    applyTheme(defaultTheme);
  }
  if (toggleBtn) {
    toggleBtn.addEventListener('click', () => {
      const current = htmlEl.getAttribute('data-theme');
      applyTheme(current === 'light' ? 'dark' : 'light');
    });
  }
})();
</script>
</body>
</html>
